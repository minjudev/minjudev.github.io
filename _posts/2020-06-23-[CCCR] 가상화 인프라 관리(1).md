# Virtualization 개요
## 가상화 개념
### 1. 가상화란?
- 물리적인 하드웨어 장치를 논리적인 객체로 추상화하는 것   
- 하나의 하드웨어를 여러 장치처럼 동작시키거나 여러 장치를 하나의 하드웨어처럼 사용자에게 제공할 수 있는 것   
[출처 - 가상화란 무엇인가?](https://kim-dragon.tistory.com/5)
- 가상 시스템은 서로 독립적
- 리소스의 효율적 사용 가능
- 서버의 쉽고 빠른 배포
- 중앙집중화된 가상화 인프라 구성 가능
- 하이퍼바이저
  - 호스트 컴퓨터에서 다수의 운영체제를 동시에 실행하기 위한 논리적 플랫폼
  - 가상화의 관리 및 지원
- 호스트: 물리적인 시스템
- 게스트: 하이퍼바이저 상에서 실행되는 가상머신

### 1 - 1) 전 가상화(Full Virtualization)
- 가상머신이 제공받은 하드웨어가 전부 가상의 하드웨어
- 전 가상화로 만들어진 가상머신은 자신이 가상머신인지 알지 못함
- 물리적인 하드웨어에 접근할 때 하이퍼바이저에 의해 제어됨
- 하이퍼바이저는 가상머신들의 각기 다른 명령을 해석해서 하드웨어에 전달
- 전 가상화는 트랩과 에뮬레이트 작업을 거치므로 성능이 떨어짐
- 대부분의 운영체제를 쉽게 설치 가능
- 장점: 기존 운영체제를 수정 없이 사용 가능

### 1 - 2) 반 가상화(Para-Virtualization)
- 운영체제의 커널 소스를 수정한 가상화
- 하이퍼바이저가 가상머신에게 특수한 인터페이스 제공
- 반 가상화는 전 가상화보다 오버헤드(어떤 처리를 하기 위해 들어가는 간접적인 처리 시간)가 적음
- 운영체제의 커널 소스를 수정해야 하므로 오픈소스 운영체제로 한정
- 운영체제가 하이퍼바이저가 알아들을 수 있는 명령을 바로 내림

### 2. 하이퍼바이저(Hypervisor)
- 가상화를 구현하기 위한 기반이 되는 기술
- 각 가상머신에서 수행하는 명령을 해석해 하드웨어가 올바른 동작을 할 수 있게 중재하는 역할
- 하드웨어를 소프트웨어적으로 파티셔닝하여 가상머신에게 제공
- 가상화에서는 독립성 유지가 매우 중요   
- 주요 기능: 시스템 자원 관리, 모니터링, 독립성 유지, 주변 장치 제공   
[출처 - 하이퍼바이저, 전가상화, 반가상화](https://itholic.github.io/hypervisor/)

![Untitled Diagram](https://user-images.githubusercontent.com/53208493/85394607-c6e0f500-b589-11ea-8555-90c3897e0dce.png)

### 2 - 1) Native/Bare-metal Hypervisor(Type 1)
- 물리적인 머신에 하이퍼바이저 소프트웨어를 설치
- 하이퍼바이저가 해당 하드웨어 위에서 직접 실행됨
- 별도의 운영체제가 필요 없음
- 하이퍼바이저를 관리할 시스템이 존재해야 함

### 2 - 2) Hosted Hypervisor(Type 2)
- 운영체제가 설치된 머신에서 하이퍼바이저 소프트웨어를 설치
- 하이퍼바이저는 일반 프로그램과 같이 호스트 운영체제에서 실행됨
- 하이퍼바이저를 관리할 시스템이 존재하지 않아도 됨

### 3. 클라우드 컴퓨팅
- 가상화는 클라우드 컴퓨팅의 기본 토대를 제공
- 가상화와 클라우드 컴퓨팅은 서로 별개
- 가상화는 특정 응용프로그램에 사용할 리소스가 한정적일 경우 적합

### 가상화와 클라우드 컴퓨팅 비교
|가상화|클라우드|
|:-----:|:--------:|
|개별 물리적 시스템에 대해 여러 개의 가상환경을 생성|온디맨드 사용을 위한 가상 리소스 풀링과 자동화|
|자원의 장기적 할당|단기 자원 배분|
|stateful|stateless|
|인프라 수준의 고가용성|응용 프로그램 계층에서의 고가용성|
|Scales up(수직 확장: 크기의 증가)|Scales out(수평 확장: 개수의 증가)|

### 4. oVirt
- Host와 Guest 시스템을 중앙에서 관리하는 가상화 플랫폼(PaaS)
- oVirt에서 제공하는 기능
  - hardware node 관리
  - 스토리지 및 네트워크 자원 관리
  - 가상머신 배포 및 관리
  - 마이그레이션 및 고가용성
  - 시스템 스케줄링 및 파워 관리
  - 각 노드 및 전체적인 플랫폼 모니터링

### KVM(Kernel-based Virtual Machine)
  - 커널과 직접적으로 통합된 하이퍼바이저
  - Native 하이퍼바이저 호스트에서 커널이 하이퍼바이저 역할을 하도록 함
  - **Thin Hypervisor Host**
    - Native(또는 Bare-metal)형 하이퍼바이저
    - Host 시스템에서는 어떤 서비스도 제공되어선 안됨(ssh 제외)
    - Host 시스템은 가상화 관리를 위해서만 사용
    - Guest 시스템은 애플리케이션 및 서비스 제공
    - Host 시스템 자체가 불안정하거나 공격 받으면 Guest에 영향
  - **Thick Hypervisor Host**
    - Hosted형 하이퍼바이저
    - Host 시스템의 운영체제에 하이퍼바이저 소프트웨어를 설치해 사용
    - Guest 시스템을 설치하기가 쉬움
    - 개발, 테스트, 시연, 강의 용도로 사용하기에 적당
  - KSM(Kernel Same-page Merging)
    - KVM의 메모리 관리 기법
    - Host 시스템에서 Guest OS가 동일하면 메모리의 페이지를 공유
  - 장치 모델(Device Model)
    - Guest가 실제 H/W에 접근하는 것은 불가능
    - 실제 H/W와 같은 역할을 할 가상의 H/W 필요
    - Guest에 에뮬레이트된 가상의 H/W 제공
    - QEMU를 통한 H/W 에뮬레이트
  - VirtIO(Virtualization Input/Output)
    - 에뮬레이트된 가상의 H/W는 실제 H/W보다 성능이 좋지 않음
    - 반 가상화 I/O 장치를 Guest에게 부여 -> 성능 향상
    - 이를 위해 Guest 시스템에서 추가 드라이버를 설치해야 함
    
## oVirt 구성 요소
### 1. 엔진(Engine)
- 물리적 자원과 가상의 자원을 중앙에서 관리하기 위한 플랫폼
- oVirt의 코어 구성요소(Manager 또는 Engine이라고 함)
- 웹 서비스로 실행되는 JBoss 기반 Java 응용 프로그램
- Enterprise Linux 위에 설치
- 데이터는 데이터베이스에 저장(PostgreSQL)
- 디렉토리 서버를 통한 사용자 관리
- GUI와 RESTful API를 통한 데이터센터 구성요소 관리
> RESTful API: REST 특징을 지키면서 API를 제공하는 것   
>> REST(REpresentational State Transfer)   
>> 웹에 존재하는 모든 자원에 고유한 URI를 부여해 활용   
>> 자원을 정의하고 자원에 대한 주소를 지정하는 방법론
- SPICE 프로토콜을 사용해 가상머신 그래픽 콘솔 접근 가능   
> SPICE(Simple Protocol for Independent Environments): 가상 환경용 통신 프로토콜   
> - 사용자는 인턴넷을 통해 어디서나 가상머신의 콘솔을 볼 수 있음
- 두 가지 유형의 배포방식 지원

#### 1) Standalone Manager
- 별도의 물리적 시스템 또는 가상화 환경에서 호스트되는 가상 시스템에서 실행
- 일반적으로는 물리적 시스템으로 배포
- 배포 및 관리가 더 쉬움
- 추가적인 물리서버 필요
- 추가적인 제품을 통해 외부관리 가능

#### 2) Self-Hosted Engine
- 엔진이 관리하는 oVirt 환경에서 가상 시스템으로 설치
- 실제 서버가 하나 더 적은 것이 장점
- 배포 및 관리에 오버헤드가 더 많은 것이 단점
> 오버헤드: 어떤 처리를 하기 위해 들어가는 간접적인 처리 시간 · 메모리
- 고가용성 
  - 외부 HA 관리 없이도 가용성이 높음
  - 두 개 이상의 셀프 호스트 엔진이 필요
> 가용성: 정보 시스템을 정상적으로 사용 가능한 정도

### 2. 호스트(Hosts)
- 하나 이상의 가상 시스템을 실행하는 물리적인 서버
- KVM을 사용해 완전 가상화 제공
- 클러스터로 그룹화(그룹 내 마이그레이션 가능)
- 호스트 요구사항
  - AMD-V 또는 Intel VT 하드웨어 가상화 확장 기능을 지원하는 CPU 필요
  - 최소 2GB RAM 필요
- oVirt Nodes 또는 Enterprise Linux Hosts 방식 제공
  - oVirt Nodes
    - 단일 베어메탈 하이퍼바이저(Standalone Bare-metal Hypervisor)
    - 호스트 제공에 필요한 패키지만 구성 - 유지 관리의 단순화
  - Enterprise Linux Hosts
    - 기존의 Enterprise Linux를 바탕으로 호스트 구성
    - oVirt Nodes 보다 유연
    - 타사 감시장치가 있을 경우 VDSM과 충돌 가능성 있음
 - VDSM(Virtual Desktop Server Manager)   
 > 메모리, 스토리지, 네트워킹 등과 같은 호스트 리소스 감시 및 가상 머신 생성, 통계자료 축적, 로그 수집 등의 작업을 관리한다.
  - 엔진의 agent로 제공되는 관리 모듈
  - Manager 및 호스트 간의 통신을 허용
  - 호스트, 가상머신, 네트워크 및 스토리지 관리
  - 호스트 및 게스트에서 통계 검색 가능
  - VDSM은 libvirtd를 사용해 가상 머신을 시작, 중지, 재부팅 등의 명령 전송

### 3. 스토리지 저장소(Storage)
- 디스크 이미지, 템플릿 및 ISO 파일에 대한 접근 제공
- 다양한 파일시스템 및 블록장치 접근 방식 지원
- 백업 시 인프라의 NAS 또는 SAN 하드웨어에 의해 제공
- 세 가지 유형의 도메인 제공
  - 데이터 도메인: 가상머신 디스크 이미지와 템플릿 저장
  - ISO 도메인: 설치 시 필요한 ISO 파일 저장
  - 내보내기 도메인: 백업 및 마이그레이션을 위한 임시 저장소(데이터 도메인에서 바로 수행 가능)

### 4. 데이터 웨어하우스(Data Warehouse)
- 보고 목적의 정보 기록
- ovirt_engine_history 데이터베이스 생성
- Manager 설치 시 함께 설치 및 구성
- 데이터센터, 클러스터, 호스트 수준에서 다양한 정보 추출
- 사용할 공간 및 자원의 예상치 계산

### 5. 네트워크(Network in RHV)
- oVirt 환경 구성을 위한 필수 조건
- 스토리지 및 호스트 관리
- 사용자 연결 및 가상 컴퓨터 연결
- 논리적 네트워크를 정의
  - 네트워크 트래픽 분리
  - 물리적 토폴로지 가상화
- ovirtmgmt 논리 네트워크 기본 생성 -> oVirt와 호스트 간의 관리 용도
